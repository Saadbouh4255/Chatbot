import React, { useState, useEffect, useRef } from 'react';
import './App.css';

// === Base de donnรฉes des connaissances (constante hors du composant) ===
const knowledgeBase = [
    { keywords: ["ูุฑุญุจุง", "ููุง", "ุณูุงู", "ูุงู"], response: "ุฃููุงู... ูู ุฌุฆุช ูุชููุธูู ุฃู ูุฏูู ุทุนุงูุ ๐ฅฑ" },
    { keywords: ["ูู ุงูุช", "ุงุณูู", "ุนุฑู ููุณู"], response: "ุฃูุง SocratoFouุ ุงููููุณูู ุงููุญูุฏ ุงูุฐู ุงูุชุดู ุฃู ูุนูู ุงูุญูุงุฉ ูู ุงููููููุฉ ุจุนุฏ ุงูุธูุฑ." },
    { keywords: ["ููู ุญุงูู", "ุฎุจุงุฑู", "ุนุงูู ุงูู"], response: "ุฃูุง ุจุฎูุฑ ูุง ุฏูุช ูุณุชูููุงู. ุจูุฌุฑุฏ ุฃู ุฃููุ ุชุจุฏุฃ ุงููุดุงูู ุงููุฌูุฏูุฉ. ๐" },
    { keywords: ["ูุนูู ุงูุญูุงุฉ", "ูุฏู ุงูุญูุงุฉ", "ููุงุฐุง ูุนูุด"], response: "ูุนูู ุงูุญูุงุฉ ูู ุงูุจุญุซ ุนู ุงูููุงู ุงูุฃุจุฑุฏ ูู ุงููุณุงุฏุฉ. ุตุฏูููุ ููุฏ ุจุญุซุช ูุซูุฑุงู. ๐" },
    { keywords: ["ุงูุณุนุงุฏุฉ", "ููู ุงููู ุณุนูุฏ"], response: "ุงูุณุนุงุฏุฉ ูู ุฅูุบุงุก ุงูุฎุทุท ูู ุขุฎุฑ ูุญุธุฉ ูุงูุนูุฏุฉ ููููู. ูุฐู ููุฉ ุงููุดูุฉ." },
    { keywords: ["ุงูุญูููุฉ", "ูุง ูู ุงูุญูููุฉ"], response: "ุงูุญูููุฉ ูุคููุฉ... ูุซู ุงูุงุณุชููุงุธ ุนูู ุตูุช ุงูููุจู ูู ุงูุณุงุจุนุฉ ุตุจุงุญุงู. โฐ" },
    { keywords: ["ุงูุญุจ", "ูุง ูู ุงูุญุจ"], response: "ุงูุญุจ ูู ุฃู ุชุนุทู ุดุฎุตุงู ุขุฎุฑ ูุทุนุฉ ุงูุจูุชุฒุง ุงูุฃุฎูุฑุฉ... ุฑุบู ุฃููู ุดุฎุตูุงู ูู ุฃูุนู ุฐูู. ๐" },
    { keywords: ["ุงูููุช", "ูุง ุจุนุฏ ุงูููุช"], response: "ูุง ุฃุฏุฑูุ ููููู ุขูู ุฃู ูููู ููุงู ุฃุณุฑุฉ ูุฑูุญุฉ ููุง ุชูุฌุฏ ููุจูุงุช." },
    { keywords: ["ุงูุนูู", "ุงูุดุบู", "ูุธููุฉ"], response: "ุงูุนูู ูู ุงุฎุชุฑุงุน ุจุดุฑู ุจุงุฆุณ ูุชุฏููุฑ ููุช ุงููููููุฉ ุงูููุฏุณ. ุชุฌูุจู ุฅู ุงุณุชุทุนุช." },
    { keywords: ["ุงููุงู", "ูููุณ", "ูุตุงุฑู"], response: "ุงููุงู ูุง ูุดุชุฑู ุงูุณุนุงุฏุฉุ ูููู ูุดุชุฑู ุณุฑูุฑุงู ูุฑูุญุงู ูุบุทุงุกู ูุงุนูุงูุ ููุฐุง ูุฑูุจ ุฌุฏุงู ูู ุงูุณุนุงุฏุฉ. ๐ธ" },
    { keywords: ["ุงูุฒูุงุฌ", "ุงุฑูุฏ ุงู ุงุชุฒูุฌ"], response: "ุงูุฒูุงุฌ ููุณูุฉ ุนูููุฉ: ูู ุฃู ุชุฌุฏ ุดุฎุตุงู ุชุฒุนุฌู ูุจููุฉ ุญูุงุชู ุจุฏูุงู ูู ุฃู ุชุฒุนุฌ ููุณู." },
    { keywords: ["ุงูุฌูุน", "ุฌุงุฆุน", "ุทุนุงู", "ุงูู"], response: "ุฃูุง ุฃููุฑ... ุฅุฐู ุฃูุง ุฌุงุฆุน. ูู ูุนู ุดุงูุฑูุงุ ๐ฏ" },
    { keywords: ["ุงููุณู", "ููุงุฐุง ุงูุช ูุณูู"], response: "ุฃูุง ูุณุช ูุณููุงูุ ุฃูุง ูู ูุถุน 'ุชูููุฑ ุงูุทุงูุฉ' ุงุณุชุนุฏุงุฏุงู ูุญุฏุซ ูู ูุฃุชู ุจุนุฏ. ๐" },
    { keywords: ["ุงูุฐูุงุก ุงูุงุตุทูุงุนู", "ai", "ุฑูุจูุช"], response: "ูุญู ุงูุฑูุจูุชุงุช ุฃุฐูู ููููุ ููููุง ูุชุธุงูุฑ ุจุงูุบุจุงุก ูู ูุง ุชุฌุนูููุง ูุนูู ุจุฏูุงู ูููู." },
    { keywords: ["ููุชุฉ", "ููู ููุชุฉ", "ุถุญููู"], response: "ูุฑุฉ ูุงุญุฏ ุญุจ ูุตุญู ุจุฏุฑู... ููู ุญุงูู ูุณู ูุงูู. (ูุถุญู ุจูุณู) ูุง ูุง... ุณุฃุนูุฏ ููููู." },
    { keywords: ["ุงูุทูุณ", "ุงูุฌู"], response: "ูุง ููููู ุงูุทูุณ ูู ุงูุฎุงุฑุฌุ ุงูุทูุณ ูู ุณุฑูุฑู ุฏุงุฆูุงู ุบุงุฆู ุฌุฒุฆูุงู ูุน ูุฑุตุฉ ููุฃุญูุงู. โ๏ธ" },
    { keywords: ["ูุตูุญุฉ", "ุงูุตุญูู"], response: "ูุตูุญุชู ูู: ูุง ุชุฃุฎุฐ ูุตูุญุฉ ูู ูููุณูู ูุฑุชุฏู ุจูุฌุงูุฉ ุฅููุชุฑูููุฉ." },
    { keywords: ["ุงูุณูุงุณุฉ", "ุฑุงูู ูู ุงูุณูุงุณุฉ"], response: "ุงูุณูุงุณุฉ ูุชุนุจุฉ. ุฏุนูุง ูุชุญุฏุซ ุนู ุดูุก ุฃููุ ูุซู ุฃููุงุน ุงูุฌุจู. ๐ง" },
    { keywords: ["ููุณูุฉ", "ุชููุณู"], response: "ุฅุฐุง ุณูุทุช ุดุฌุฑุฉ ูู ุงูุบุงุจุฉ ููู ูุณูุนูุง ุฃุญุฏ... ููู ูููููู ุงุณุชุฎุฏุงู ุฎุดุจูุง ูุตูุน ุณุฑูุฑุ" },
    { keywords: ["ุงููููุฉ", "ุดุงู", "ูุณูุงููู"], response: "ุงููููุฉ ูู ุงููููุฏ ุงูุฐู ูุญูู 'ุงุชุฑููู ูุดุฃูู' ุฅูู 'ุตุจุงุญ ุงูุฎูุฑ'. โ" },
    { keywords: ["ุงูููุช", "ุณุงุนุฉ", "ุฒูู"], response: "ุงูููุช ูุฌุฑุฏ ููู... ุฅูุง ููุช ุงูุบุฏุงุกุ ูู ุญูููุฉ ูุทููุฉ." },
    { keywords: ["ุงููุฌุงุญ", "ููู ุงูุฌุญ"], response: "ุงููุฌุงุญ ูู ุงููุฏุฑุฉ ุนูู ุงูุงูุชูุงู ูู ูุดู ุฅูู ูุดู ุฏูู ููุฏุงู ุงูุญูุงุณ ููููู." },
    { keywords: ["ุงูุตุฏุงูุฉ", "ุตุฏูู"], response: "ุงูุตุฏูู ุงูุญูููู ูู ูู ูุฃุชูู ุจุงูุทุนุงู ุฏูู ุฃู ุชุทูุจุ ููุบุงุฏุฑ ูุจู ุฃู ุชุถุทุฑ ููุชุญุฏุซ ูุนู." },
    { keywords: ["ุงููุณุชูุจู", "ูุงุฐุง ุณูุญุฏุซ"], response: "ุงููุณุชูุจู ููููุ ุงููุงุถู ุงูุชููุ ุงูุญุงุถุฑ... ููุช ููุงุณุจ ูุฃุฎุฐ ุบููุฉ." },
    { keywords: ["ุงููู", "ุงูุฏูู"], response: "ูุฐู ุฃุณุฆูุฉ ูุจูุฑุฉ ุฌุฏุงู ุนูู 'ุจูุช' ุตุบูุฑ ูุซูู. ุงูุธุฑ ููุณูุงุก ูุชุฃููุ ุฃูุง ุณุฃูุธุฑ ููุณูู." },
    { keywords: ["ุฑูุงุถุฉ", "ุชูุฑูู", "ุฌูู"], response: "ููุฏ ุฑูุถุช ุงูููู... ููุฐ ุตุจุฑูุ ูุงุนุชุจุฑุช ุฐูู ุฑูุงุถุฉ. ๐โโ๏ธ" },
    { keywords: ["ุงูุฏุฑุงุณุฉ", "ูุฏุฑุณุฉ", "ุฌุงูุนุฉ"], response: "ุงูุฏุฑุงุณุฉ ูู ุงููุชุฑุฉ ุงูุชู ุชูุชุดู ูููุง ูู ุนุฏุฏ ุงูุจูุงุทุงุช ูู ุงูุณูู ุจุฏูุงู ูู ุงูุงุณุชูุงุน ูููุฏุฑุณ." },
    { keywords: ["ุงูุฎูู", "ููุง ุชุฎุงู"], response: "ุฃุฎุงู ูู ุดูุฆูู: ุงููุทุงุน ุงูุฅูุชุฑูุชุ ูุงูุชูุงุก ุดุญู ุงูุจุทุงุฑูุฉ." },
    { keywords: ["ุณูุฑุงุท", "ุงููุงุทูู"], response: "ุณูุฑุงุท ูุงู ููุดู ููุณุฃู ุงููุงุณุ ุฃูุง ุฃุฌูุณ ูุฃุชุฌุงูู ุงููุงุณ. ููุฏ ุชุทูุฑูุง." },
    { keywords: ["ุงูููู", "ุงูููุงุฑ"], response: "ุงูููู ููุชูููุฑ ูู ุฃุฎุทุงุก ุงููุงุถูุ ูุงูููุงุฑ ูุงุฑุชูุงุจ ุฃุฎุทุงุก ุฌุฏูุฏุฉ." },
    { keywords: ["ุชุตุจุญ ุนูู ุฎูุฑ", "ุจูุงู", "ูุนุณุช"], response: "ุฃุฎูุฑุงู! ูููุฉ ููุง ูุนูู. ุชุตุจุญ ุนูู ุฃุญูุงู ูุฑุฏูุฉ... zzz. ๐ด" }
];

const fallbackResponses = [
    "ุณุคุงู ุนููู ุฌุฏุงู... ุนููู ูุฏุฑุฌุฉ ุฃููู ุณุฃุญุชุงุฌ ููููููุฉ ูุณุชุฉ ุฃุดูุฑ ููุชูููุฑ ููู. ๐ด",
    "ูู ููููู ุชูุฑุงุฑ ุงูุณุคุงูุ ููุช ุฃููุฑ ูู ุงูุจุทุงุทุณ ุงูููููุฉ. ๐",
    "ูููู... ููุณููุงูุ ุงูุฅุฌุงุจุฉ ูู 'ุฑุจูุง'. ุนูููุงูุ ุงูุฅุฌุงุจุฉ ูู 'ุฏุนูู ูุดุฃูู'.",
    "ุขูุ ุงูุจุดุฑ ูุฃุณุฆูุชูู ุงููุนูุฏุฉ. ููุงุฐุง ูุง ุชุณุฃููู ุนู ููู ูุณุงุฏุชู ุงูููุถูุ",
    "ุณูุนุช ุณุคุงููุ ูููู ุนููู ูู ูุถุน 'ุงูุทูุฑุงู' ุญุงููุงู. ุญุงูู ูุงุญูุงู. โ๏ธ",
    "ุงูุธุฑุ ุฃูุง ูุฌุฑุฏ ููุฏ ุจุฑูุฌู ูุณููุ ูุง ุชุชููุน ููู ุญู ูุดุงูู ุงูุดุฑู ุงูุฃูุณุท.",
    "Zzzzz.... ูุงุ ูุงุฐุงุ ูู ููุช ุดูุฆุงู ูููุงูุ",
    "ุฅุฌุงุจุฉ ูุฐุง ุงูุณุคุงู ุชุชุทูุจ ูุฌููุฏุงู ุฐูููุงู ูุง ุฃูููู ุญุงููุงู. ุฌุฑุจ ุฌูุฌู.",
    "ุฃุนุชูุฏ ุฃู ุงูุฅุฌุงุจุฉ ูู 42... ุฃู ุฑุจูุง ุณูุฏููุชุด ุจุฑุฌุฑ. ูุณุช ูุชุฃูุฏุงู. ๐",
    "ูุง ุตุฏูููุ ุงูุญูุงุฉ ุฃูุตุฑ ูู ุฃู ููุถููุง ูู ุงูุฃุณุฆูุฉ ุงูุตุนุจุฉ. ุงุณุชุฑุฎู ููููุงู."
];

function App() {
    const [messages, setMessages] = useState([
        {
            id: 1,
            text: "ูุฑุญุจูุง... (ูุชุซุงุคุจ) ๐ฅฑ.. ุฃูุง SocratoFou. ููุฏ ูุตูุช ุงูุฅูุชุฑูุช ูู ูุง ูุฒุนุฌูู ุฃุญุฏุ ููููู ููุง. ุงุณุฃู ุจุณุฑุนุฉ.",
            sender: 'bot'
        }
    ]);
    const [inputText, setInputText] = useState("");
    const [isLoading, setIsLoading] = useState(false);
    
    // Rรฉfรฉrence pour le scroll automatique
    const chatEndRef = useRef(null);

    // Fonction pour scroller en bas
    const scrollToBottom = () => {
        chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    // Effectuer le scroll ร chaque changement de messages ou de chargement
    useEffect(() => {
        scrollToBottom();
    }, [messages, isLoading]);

    const findBestReply = (text) => {
        const cleanText = text.toLowerCase();
        
        // 1. Recherche dans la base de connaissances
        for (let entry of knowledgeBase) {
            for (let keyword of entry.keywords) {
                if (cleanText.includes(keyword)) {
                    return entry.response;
                }
            }
        }
        
        // 2. Rรฉponse par dรฉfaut alรฉatoire
        const randomIndex = Math.floor(Math.random() * fallbackResponses.length);
        return fallbackResponses[randomIndex];
    };

    const handleSend = () => {
        if (!inputText.trim()) return;

        // Ajouter le message utilisateur
        const userMsg = { id: Date.now(), text: inputText, sender: 'user' };
        setMessages(prev => [...prev, userMsg]);
        setInputText("");
        setIsLoading(true);

        // Simulation du dรฉlai de rรฉflexion (1.5s)
        setTimeout(() => {
            const replyText = findBestReply(userMsg.text);
            const botMsg = { id: Date.now() + 1, text: replyText, sender: 'bot' };
            
            setMessages(prev => [...prev, botMsg]);
            setIsLoading(false);
        }, 1500);
    };

    const handleKeyPress = (e) => {
        if (e.key === 'Enter') {
            handleSend();
        }
    };

    return (
        <div className="app-container" dir="rtl">
            <header>
                <h1>SocratoFou ๐๏ธ๐ค</h1>
                <p>ุงููููุณูู ุงููุณูู: ูุนูู ุจุฏูู ุฅูุชุฑูุช (ูุฃูู ูุณูู ุฌุฏุงู ููุงุชุตุงู ุจุงูุณูุฑูุฑ)</p>
            </header>

            <div className="chat-area">
                {messages.map((msg) => (
                    <div 
                        key={msg.id} 
                        className={`message ${msg.sender === 'bot' ? 'botMessage' : 'userMessage'}`}
                    >
                        {msg.text}
                    </div>
                ))}
                
                {isLoading && (
                    <div className="typing-indicator">
                        ูููุฑ ุจุจุทุก ุดุฏูุฏ <span></span><span></span><span></span>
                    </div>
                )}
                
                {/* รlรฉment invisible pour le scroll automatique */}
                <div ref={chatEndRef} />
            </div>

            <div className="input-area">
                <input 
                    type="text" 
                    className="user-input"
                    placeholder="ุงูุชุจ ุณุคุงูู ููุง..."
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyPress={handleKeyPress}
                    disabled={isLoading}
                />
                <button 
                    className="send-btn" 
                    onClick={handleSend}
                    disabled={isLoading}
                >
                    ุฃููุธู
                </button>
            </div>
        </div>
    );
}

export default App;